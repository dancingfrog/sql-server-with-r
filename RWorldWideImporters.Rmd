---
title: "RSQLServer"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Importing SQL Server data into R

Load the RODBC package:
```{r RODBC}
library(RODBC)
options(warn = -1)
```

Define the connection:
```{r connection}
print(getwd())
creds <- readLines(file("./passwd"))
print(creds[1])
print(creds[2])

# On Windows
driver <- "Driver=SQL Server"
# On Linux / Mac OS X:
#driver <- "Driver={ODBC Driver 17 for SQL Server}"

# Local
server <- "Server=WIN-VHQQULMEB4K;trusted_connection=true"
# Remote
#server <- "Server=ec2-52-21-198-129.compute-1.amazonaws.com"

connStr <- paste(driver, ";", server,";Database=WideWorldImporters;Persist Security Info=True;User ID=", creds[1], ";Password=", creds[2], ";", sep="")
print(connStr)

dbHandle <- RODBC::odbcDriverConnect(connStr)
```

Define the query
```{r query}
order_query <- "select top 100 DATEFROMPARTS(YEAR(o.[OrderDate]), MONTH(o.[OrderDate]), 1) As OrderMonth,
  sp.[PreferredName] as SalesPerson,
  COUNT(distinct o.[OrderId]) as OrderCount,
  SUM(ol.[Quantity] * ol.[UnitPrice]) as TotalAmount
	from [Sales].[Orders] o
	  inner join [Sales].[OrderLines] ol
	    on ol.[OrderId] = o.[OrderId]
	  inner join [Application].[People] sp
	    on sp.[PersonId] = o.[SalespersonPersonId]
	where sp.[ValidTo] >= GETDATE()
	  and o.[OrderDate] between '20150101' and '20151231'
	group by DATEFROMPARTS(YEAR(o.[OrderDate]), MONTH(o.[OrderDate]), 1), sp.[PreferredName]
  order by OrderCount DESC;"
```

Execute the query and store the results
```{r results}
orders <- RODBC::sqlQuery(dbHandle, order_query)
View(orders)
str(orders)
```
